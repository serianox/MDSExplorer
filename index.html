<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <title>MDS Explorer</title>
    </head>
    <body>
        <h1>MDS Explorer</h1>

        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

        <script>
            let get = (url, success) => {
                $.get({
                    url: url.replace('https://mds.fidoalliance.org', 'http://localhost:8000'),
                    data: {},
                    success: success,
                    error: (jqXHR, textStatus, errorThrown) => console.log(errorThrown)
                });
            };
            let renderMetadataStatement = (statement) => {
                let content = '<h3 class="card-header">' + statement.description + '</h3>';
                content += '<div class="card-block">';
                if ('icon' in statement) {
                    content += '<div style="float: right; width: 128px; height: 64px"><img style="float: right; max-width: 100%;max-height: 100%; padding: 12px" src="' + statement.icon + '"/></div>';
                }
                content += '<p><li>';
                let id = _ => _;
                [
                    ['legalHeader', id],
                    ['aaid', id],
                    ['aaguid', id],
                    ['attestationCertificateKeyIdentifiers', id],
                    ['description', id],
                    ['alternativeDescriptions', JSON.stringify],
                    ['authenticatorVersion', id],
                    ['protocolFamily', id],
                    ['upv', _ => _.map(_ => '' + _.major + '.' + _.minor).join(', ')],
                    ['assertionScheme', id],
                    ['authenticationAlgorithm', id],
                    ['authenticationAlgorithms', id],
                    ['publicKeyAlgAndEncoding', id],
                    ['publicKeyAlgAndEncodings', id],
                    ['attestationTypes', JSON.stringify],
                    ['userVerificationDetails', JSON.stringify],
                    ['keyProtection', id],
                    ['isKeyRestricted', id],
                    ['isFreshUserVerificationRequired', id],
                    ['matcherProtection', id],
                    ['cryptoStrength', id],
                    ['operatingEnv', id],
                    ['attachmentHint', id],
                    ['isSecondFactorOnly', id],
                    ['tcDisplay', id],
                    ['tcDisplayContentType', id],
                    ['tcDisplayPNGCharacteristics', JSON.stringify],
                    ['attestationRootCertificates', _ => _.map(_ => '<a href="data:application/x-pem-file;base64,' + _ + '">' + _.substr(1, 10) + 'â€¦</a>').join(', ')],
                    ['ecdaaTrustAnchors', JSON.stringify],
                    ['supportedExtensions', JSON.stringify],
                ].forEach(_ => {
                    let [p, a] = _;
                    if (p in statement) {
                        content += '<ul>' + p + ': ' + a(statement[p]) + '</ul>';
                    }
                });
                content += '</p></li></div>';
                return content;
            }
            let processMetadataStatement = (data, id) => {
                let statement = JSON.parse(atob(data));
                let content = renderMetadataStatement(statement)
                $('[id="' + id + '"]').append(content);
            };
            let processToC = (data) => {
                let [header, payload, signature] = data.split('.');
                let toc = JSON.parse(atob(payload));
                for (let entry of toc.entries) {
                    let id = entry.hash;
                    $('body').append('<div class="card" id="' + id + '"></div>');
                    get(entry.url, (data) => processMetadataStatement(data, id));
                }
            };
            get('https://mds.fidoalliance.org', processToC);
        </script>
    </body>
</html>